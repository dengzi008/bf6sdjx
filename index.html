<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å£°ä¸œå‡»è¥¿ï¼šè¿·åŸå¥‡è¢­ - ä¸‰åå…­è®¡ç¬¬å…­è®¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
            background: #0a0e27;
            color: #fff;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #gameContainer {
            width: 100%;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #uiOverlay {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            height: 100%;
            pointer-events: none;
        }

        #topBar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            pointer-events: auto;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .stat-bar {
            width: 120px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90e2, #357abd);
            transition: width 0.3s;
            border-radius: 10px;
        }

        .stat-text {
            min-width: 60px;
            font-weight: bold;
        }

        #centerArea {
            flex: 1;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
            pointer-events: none;
        }

        .gate-display {
            text-align: center;
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            min-width: 120px;
        }

        .gate-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .gate-label {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .gate-status {
            font-size: 12px;
            color: #ffd700;
        }

        #bottomBar {
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            pointer-events: auto;
        }

        #actionButtons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            min-height: 50px;
            flex: 1;
            min-width: 140px;
            max-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-success:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-item {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-item:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-item:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-cooldown {
            position: relative;
        }

        .cooldown-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
        }

        #modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #ffd700;
        }

        .modal-text {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .modal-btn {
            padding: 12px 30px;
            font-size: 18px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }

        .event-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.95);
            color: #000;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            z-index: 50;
            animation: popupAnim 0.5s;
            pointer-events: none;
        }

        @keyframes popupAnim {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .stat-item {
                font-size: 12px;
            }

            .stat-bar {
                width: 80px;
                height: 18px;
            }

            .gate-icon {
                font-size: 36px;
            }

            .btn {
                font-size: 14px;
                padding: 15px 12px;
                min-height: 55px;
            }

            #topBar {
                padding: 8px 10px;
            }

            .modal-content {
                padding: 20px;
            }

            .modal-title {
                font-size: 20px;
            }

            .modal-text {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="uiOverlay">
            <div id="topBar">
                <div class="stat-item">
                    <span>è¿·æƒ‘å€¼:</span>
                    <div class="stat-bar">
                        <div class="stat-fill" id="confusionBar" style="width: 0%"></div>
                    </div>
                    <span class="stat-text" id="confusionText">0%</span>
                </div>
                <div class="stat-item">
                    <span>ç²®è‰:</span>
                    <span class="stat-text" id="supplyText">0/1000</span>
                </div>
                <div class="stat-item">
                    <span>æ³¢æ¬¡:</span>
                    <span class="stat-text" id="waveText">1/âˆ</span>
                </div>
                <div class="stat-item">
                    <span>æœ€é«˜åˆ†:</span>
                    <span class="stat-text" id="highScoreText">0</span>
                </div>
            </div>

            <div id="centerArea">
                <div class="gate-display">
                    <div class="gate-icon">ğŸ¯</div>
                    <div class="gate-label">ä¸œé—¨</div>
                    <div class="gate-status" id="eastStatus">å‡æ”»ä¸­</div>
                </div>
                <div class="gate-display">
                    <div class="gate-icon">ğŸ¯</div>
                    <div class="gate-label">è¥¿é—¨</div>
                    <div class="gate-status" id="westStatus">å¾…æœº</div>
                </div>
            </div>

            <div id="bottomBar">
                <div id="actionButtons">
                    <button class="btn btn-primary" id="fakeAttackBtn">å‡æ”»ä¸œé—¨ (+è¿·æƒ‘20)</button>
                    <button class="btn btn-success" id="sneakAttackBtn" disabled>å¥‡è¢­è¥¿é—¨ (æ—¶æœºæœªåˆ°)</button>
                    <button class="btn btn-item" id="smokeBtn">çƒŸé›¾ğŸ‘» (CD:0s)</button>
                    <button class="btn btn-item" id="intelBtn">å‡æƒ…æŠ¥ğŸ“œ (CD:0s)</button>
                    <button class="btn btn-item" id="arrowBtn">å¼“ç®­ğŸ¹ (CD:0s)</button>
                </div>
            </div>
        </div>

        <div id="modal">
            <div class="modal-content" id="modalContent"></div>
        </div>
    </div>

    <script>
        // ==================== æ¸¸æˆæ ¸å¿ƒé…ç½® ====================
        const CONFIG = {
            // åŸºç¡€æ•°å€¼
            INITIAL_CONFUSION: 0,
            INITIAL_SUPPLY: 0,
            INITIAL_ENEMY_EAST: 50, // æ•Œä¸»åŠ›åœ¨ä¸œé—¨çš„ç™¾åˆ†æ¯”
            
            // æ³¢æ¬¡é…ç½®
            WAVE_DURATION: 15000, // 15ç§’/æ³¢
            CONFUSION_THRESHOLD: 70, // åŸºç¡€è¿·æƒ‘å€¼é˜ˆå€¼
            CONFUSION_THRESHOLD_INC: 5, // æ¯æ³¢é˜ˆå€¼å¢åŠ 
            CONFUSION_PER_ATTACK: 20, // æ¯æ¬¡å‡æ”»å¢åŠ è¿·æƒ‘å€¼
            
            // å¥‡è¢­é…ç½®
            SNEAK_WINDOW: 10000, // å¥‡è¢­æ—¶æœºçª—å£10ç§’
            SNEAK_REWARD: 200, // å¥‡è¢­æˆåŠŸå¥–åŠ±ç²®è‰
            SNEAK_RISK_BASE: 15, // åŸºç¡€é£é™©ç™¾åˆ†æ¯”
            SNEAK_RISK_INC: 3, // æ¯æ³¢é£é™©å¢åŠ 
            
            // é“å…·é…ç½®
            SMOKE_CONFUSION: 30, // çƒŸé›¾å¢åŠ è¿·æƒ‘å€¼
            SMOKE_CD: 12000, // çƒŸé›¾å†·å´12ç§’
            INTEL_SLOW: 0.5, // å‡æƒ…æŠ¥å‡æ…¢æ•Œç§»åŠ¨é€Ÿåº¦
            INTEL_CD: 15000, // å‡æƒ…æŠ¥å†·å´15ç§’
            ARROW_RISK_REDUCE: 20, // å¼“ç®­å‡å°‘é£é™©
            ARROW_CD: 10000, // å¼“ç®­å†·å´10ç§’
            
            // éšæœºäº‹ä»¶æ¦‚ç‡
            EVENT_CHANCE: 0.2, // 20%æ¦‚ç‡è§¦å‘äº‹ä»¶
            EVENT_ENEMY_SUSPICION: 0.5, // æ•Œæ–¥å€™ç–‘äº‹ä»¶æ¦‚ç‡ï¼ˆåœ¨äº‹ä»¶ä¸­ï¼‰
            EVENT_MIST_BONUS: 0.5, // è¿·é›¾åŠ©æ”»äº‹ä»¶æ¦‚ç‡ï¼ˆåœ¨äº‹ä»¶ä¸­ï¼‰
            
            // éš¾åº¦é€’å¢
            WAVE_DEFENSE_START: 5, // ç¬¬5æ³¢å¼€å§‹é˜²å¾¡æå‡
            WAVE_DEFENSE_CONFUSION_INC: 15, // é˜²å¾¡æå‡åè¿·æƒ‘é˜ˆå€¼é¢å¤–å¢åŠ 
            WAVE_DEFENSE_RISK_INC: 15, // é˜²å¾¡æå‡åé£é™©é¢å¤–å¢åŠ 
            GREED_MULTIPLIER: 1.5, // è´ªå¿ƒç¿»å€ï¼ˆé£é™©ç¿»1.5å€ï¼‰
            
            // èƒœåˆ©æ¡ä»¶
            VICTORY_SUPPLY: 1000, // å¤§èƒœæ‰€éœ€ç²®è‰
            LEGENDARY_SUPPLY: 1500, // ç¥ç»“å±€æ‰€éœ€ç²®è‰
            
            // åˆ†æ•°è®¡ç®—
            SCORE_BASE_MULTIPLIER: 1.3, // åˆ†æ•°åŸºç¡€å€æ•°
        };

        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        let gameState = {
            confusion: CONFIG.INITIAL_CONFUSION,
            supply: CONFIG.INITIAL_SUPPLY,
            wave: 1,
            enemyEastPercent: CONFIG.INITIAL_ENEMY_EAST,
            
            // æ³¢æ¬¡è®¡æ—¶
            waveStartTime: Date.now(),
            waveElapsed: 0,
            
            // å¥‡è¢­çŠ¶æ€
            sneakWindowOpen: false,
            sneakWindowStart: 0,
            sneakWindowEnd: 0,
            
            // é“å…·çŠ¶æ€
            smokeCooldown: 0,
            intelCooldown: 0,
            arrowCooldown: 0,
            intelActive: false,
            arrowActive: false,
            
            // åŠ¨ç”»çŠ¶æ€
            animations: [],
            particles: [],
            
            // æ¸¸æˆçŠ¶æ€
            gameStarted: false,
            gameOver: false,
            tutorialShown: false,
            
            // æ‹–æ‹½çŠ¶æ€ï¼ˆæ‰‹æœºï¼‰
            isDragging: false,
            dragStartX: 0,
            dragStartY: 0,
            cameraOffsetX: 0,
            cameraOffsetY: 0,
        };

        // ==================== Canvas è®¾ç½® ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ==================== æœ¬åœ°å­˜å‚¨ ====================
        function getHighScore() {
            return parseInt(localStorage.getItem('sneakAttackHighScore') || '0');
        }

        function saveHighScore(score) {
            const current = getHighScore();
            if (score > current) {
                localStorage.setItem('sneakAttackHighScore', score.toString());
                return true;
            }
            return false;
        }

        // ==================== éŸ³æ•ˆç³»ç»Ÿ ====================
        const sounds = {
            fakeAttack: null,
            sneakAttack: null,
            victory: null,
            failure: null,
        };

        function playSound(type) {
            // ä½¿ç”¨Web Audio APIåˆ›å»ºç®€å•éŸ³æ•ˆ
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'fakeAttack':
                    oscillator.frequency.value = 200;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'sneakAttack':
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
                case 'victory':
                    oscillator.frequency.value = 400;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.8);
                    break;
                case 'failure':
                    oscillator.frequency.value = 150;
                    oscillator.type = 'triangle';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.4);
                    break;
            }
        }

        // ==================== åŠ¨ç”»ç³»ç»Ÿ ====================
        class Particle {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = (Math.random() - 0.5) * 4;
                this.life = 1.0;
                this.decay = 0.02;
                this.type = type;
                this.size = Math.random() * 5 + 3;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
                return this.life > 0;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.type === 'fire' ? '#ff6b35' : '#4a90e2';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        class Animation {
            constructor(type, x, y, duration) {
                this.type = type;
                this.x = x;
                this.y = y;
                this.startTime = Date.now();
                this.duration = duration;
                this.progress = 0;
            }

            update() {
                this.progress = (Date.now() - this.startTime) / this.duration;
                return this.progress < 1;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = 1 - this.progress;
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                
                if (this.type === 'sneak') {
                    ctx.fillText('ğŸ’¥', this.x, this.y);
                } else if (this.type === 'fake') {
                    ctx.fillText('âš”ï¸', this.x, this.y);
                }
                
                ctx.restore();
            }
        }

        // ==================== Canvas ç»˜åˆ¶ ====================
        function drawBackground() {
            // å¢¨è“è¿·é›¾æ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0a0e27');
            gradient.addColorStop(0.5, '#1a1f3a');
            gradient.addColorStop(1, '#0f1425');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // è¿·é›¾æ•ˆæœ
            ctx.fillStyle = 'rgba(100, 120, 180, 0.1)';
            for (let i = 0; i < 20; i++) {
                const x = (Date.now() * 0.01 + i * 100) % canvas.width;
                const y = (Date.now() * 0.02 + i * 50) % canvas.height;
                ctx.beginPath();
                ctx.arc(x, y, 50 + Math.sin(Date.now() * 0.001 + i) * 20, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawGates() {
            const gateWidth = 150;
            const gateHeight = 200;
            const eastX = canvas.width * 0.25;
            const westX = canvas.width * 0.75;
            const gateY = canvas.height * 0.4;

            // ä¸œé—¨ï¼ˆç¯ç«çº¢ï¼‰
            ctx.save();
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#ff4444';
            ctx.fillStyle = gameState.sneakWindowOpen ? '#ff6666' : '#cc3333';
            ctx.fillRect(eastX - gateWidth/2, gateY - gateHeight/2, gateWidth, gateHeight);
            
            // ä¸œé—¨è£…é¥°
            ctx.fillStyle = '#ffaa00';
            ctx.fillRect(eastX - gateWidth/2 + 10, gateY - gateHeight/2 + 10, gateWidth - 20, 20);
            ctx.fillRect(eastX - gateWidth/2 + 10, gateY + gateHeight/2 - 30, gateWidth - 20, 20);
            
            // ä¸œé—¨æ——å¸œ
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.moveTo(eastX + gateWidth/2, gateY - gateHeight/2);
            ctx.lineTo(eastX + gateWidth/2 + 30, gateY - gateHeight/2 - 20);
            ctx.lineTo(eastX + gateWidth/2, gateY - gateHeight/2 - 10);
            ctx.fill();
            ctx.restore();

            // è¥¿é—¨ï¼ˆæ¼†é»‘ï¼‰
            ctx.save();
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#0000ff';
            ctx.fillStyle = gameState.sneakWindowOpen ? '#3333cc' : '#000033';
            ctx.fillRect(westX - gateWidth/2, gateY - gateHeight/2, gateWidth, gateHeight);
            
            // è¥¿é—¨è£…é¥°
            ctx.fillStyle = '#444444';
            ctx.fillRect(westX - gateWidth/2 + 10, gateY - gateHeight/2 + 10, gateWidth - 20, 20);
            ctx.fillRect(westX - gateWidth/2 + 10, gateY + gateHeight/2 - 30, gateWidth - 20, 20);
            
            // è¥¿é—¨æ——å¸œï¼ˆå¥‡è¢­æ—¶äº®èµ·ï¼‰
            if (gameState.sneakWindowOpen) {
                ctx.fillStyle = '#00ff00';
                ctx.beginPath();
                ctx.moveTo(westX + gateWidth/2, gateY - gateHeight/2);
                ctx.lineTo(westX + gateWidth/2 + 30, gateY - gateHeight/2 - 20);
                ctx.lineTo(westX + gateWidth/2, gateY - gateHeight/2 - 10);
                ctx.fill();
            }
            ctx.restore();
        }

        function drawEnemyForces() {
            const barWidth = 300;
            const barHeight = 30;
            const barX = canvas.width / 2 - barWidth / 2;
            const barY = canvas.height * 0.15;

            // æ•Œä¸»åŠ›æ¡èƒŒæ™¯
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.fillRect(barX, barY, barWidth, barHeight);

            // æ•Œä¸»åŠ›æ¡ï¼ˆçº¢è‰²ï¼Œæ˜¾ç¤ºåœ¨ä¸œé—¨çš„ç™¾åˆ†æ¯”ï¼‰
            const fillWidth = (barWidth * gameState.enemyEastPercent / 100);
            const gradient = ctx.createLinearGradient(barX, barY, barX + fillWidth, barY);
            gradient.addColorStop(0, '#ff0000');
            gradient.addColorStop(1, '#cc0000');
            ctx.fillStyle = gradient;
            ctx.fillRect(barX, barY, fillWidth, barHeight);

            // æ•Œä¸»åŠ›æ¡è¾¹æ¡†
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(barX, barY, barWidth, barHeight);

            // æ•Œä¸»åŠ›æ ‡ç­¾
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('æ•Œä¸»åŠ›åˆ†å¸ƒ', canvas.width / 2, barY - 10);
            ctx.fillText(`ä¸œé—¨: ${Math.round(gameState.enemyEastPercent)}%`, canvas.width / 2, barY + barHeight + 20);
        }

        function drawSoldiers() {
            const eastX = canvas.width * 0.25;
            const westX = canvas.width * 0.75;
            const baseY = canvas.height * 0.6;

            // ä¸œé—¨å‡å…µï¼ˆå¤šï¼‰
            ctx.font = '32px Arial';
            ctx.textAlign = 'center';
            for (let i = 0; i < 5; i++) {
                const offsetX = (Math.sin(Date.now() * 0.002 + i) * 20);
                const offsetY = (Math.cos(Date.now() * 0.003 + i) * 10);
                ctx.fillText('ğŸš¶', eastX + offsetX, baseY + offsetY + i * 15);
            }

            // è¥¿é—¨çœŸå…µï¼ˆå°‘ï¼Œå¥‡è¢­æ—¶æ˜¾ç¤ºï¼‰
            if (gameState.sneakWindowOpen) {
                ctx.fillText('ğŸ‘¤', westX, baseY);
                ctx.fillText('ğŸ‘¤', westX - 20, baseY + 15);
            }
        }

        function drawParticles() {
            gameState.particles.forEach(p => {
                if (p.update()) {
                    p.draw();
                }
            });
            gameState.particles = gameState.particles.filter(p => p.life > 0);
        }

        function drawAnimations() {
            gameState.animations.forEach(anim => {
                if (anim.update()) {
                    anim.draw();
                }
            });
            gameState.animations = gameState.animations.filter(anim => anim.progress < 1);
        }

        function draw() {
            drawBackground();
            drawGates();
            drawEnemyForces();
            drawSoldiers();
            drawParticles();
            drawAnimations();
        }

        // ==================== æ¸¸æˆé€»è¾‘ ====================
        function updateWave() {
            const now = Date.now();
            gameState.waveElapsed = now - gameState.waveStartTime;

            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°è¿·æƒ‘é˜ˆå€¼
            const threshold = getConfusionThreshold();
            if (gameState.confusion >= threshold && !gameState.sneakWindowOpen) {
                openSneakWindow();
            }

            // æ›´æ–°å¥‡è¢­çª—å£
            if (gameState.sneakWindowOpen) {
                const windowElapsed = now - gameState.sneakWindowStart;
                if (windowElapsed > CONFIG.SNEAK_WINDOW) {
                    closeSneakWindow();
                }
            }

            // æ›´æ–°æ•Œä¸»åŠ›ç§»åŠ¨ï¼ˆå¦‚æœå¥‡è¢­çª—å£æ‰“å¼€ï¼‰
            if (gameState.sneakWindowOpen) {
                const moveSpeed = gameState.intelActive ? CONFIG.INTEL_SLOW : 1;
                gameState.enemyEastPercent = Math.max(0, gameState.enemyEastPercent - 0.5 * moveSpeed);
            }

            // æ›´æ–°é“å…·å†·å´
            updateCooldowns();

            // æ£€æŸ¥éšæœºäº‹ä»¶
            if (Math.random() < CONFIG.EVENT_CHANCE * 0.01) { // æ¯å¸§0.2%æ¦‚ç‡
                triggerRandomEvent();
            }
        }

        function getConfusionThreshold() {
            let threshold = CONFIG.CONFUSION_THRESHOLD;
            threshold += (gameState.wave - 1) * CONFIG.CONFUSION_THRESHOLD_INC;
            
            if (gameState.wave >= CONFIG.WAVE_DEFENSE_START) {
                threshold += CONFIG.WAVE_DEFENSE_CONFUSION_INC;
            }
            
            return threshold;
        }

        function openSneakWindow() {
            gameState.sneakWindowOpen = true;
            gameState.sneakWindowStart = Date.now();
            gameState.sneakWindowEnd = Date.now() + CONFIG.SNEAK_WINDOW;
            
            document.getElementById('sneakAttackBtn').disabled = false;
            document.getElementById('sneakAttackBtn').textContent = 'å¥‡è¢­è¥¿é—¨ (æ—¶æœºå·²åˆ°ï¼)';
            
            // æ·»åŠ åŠ¨ç”»
            const westX = canvas.width * 0.75;
            const westY = canvas.height * 0.4;
            gameState.animations.push(new Animation('sneak', westX, westY, 1000));
            
            // æ·»åŠ ç²’å­
            for (let i = 0; i < 20; i++) {
                gameState.particles.push(new Particle(westX, westY, 'fire'));
            }
        }

        function closeSneakWindow() {
            gameState.sneakWindowOpen = false;
            document.getElementById('sneakAttackBtn').disabled = true;
            document.getElementById('sneakAttackBtn').textContent = 'å¥‡è¢­è¥¿é—¨ (æ—¶æœºæœªåˆ°)';
        }

        function fakeAttack() {
            if (gameState.gameOver) return;
            
            gameState.confusion = Math.min(100, gameState.confusion + CONFIG.CONFUSION_PER_ATTACK);
            playSound('fakeAttack');
            
            // æ·»åŠ åŠ¨ç”»
            const eastX = canvas.width * 0.25;
            const eastY = canvas.height * 0.4;
            gameState.animations.push(new Animation('fake', eastX, eastY, 500));
            
            // æ·»åŠ ç²’å­
            for (let i = 0; i < 10; i++) {
                gameState.particles.push(new Particle(eastX, eastY, 'fire'));
            }
            
            updateUI();
        }

        function sneakAttack() {
            if (!gameState.sneakWindowOpen || gameState.gameOver) return;
            
            const now = Date.now();
            const windowElapsed = now - gameState.sneakWindowStart;
            
            // æ£€æŸ¥æ—¶æœº
            if (windowElapsed < CONFIG.SNEAK_WINDOW * 0.3) {
                // å¤ªæ—©ï¼Œå¤±è´¥
                handleSneakFailure('æ—¶æœºæœªåˆ°ï¼æ•Œä¸»åŠ›å°šæœªå®Œå…¨ç§»å‘ä¸œé—¨ï¼Œåæ‰‘å¤±è´¥ï¼');
                return;
            }
            
            // è®¡ç®—é£é™©
            let risk = CONFIG.SNEAK_RISK_BASE;
            risk += (gameState.wave - 1) * CONFIG.SNEAK_RISK_INC;
            
            if (gameState.wave >= CONFIG.WAVE_DEFENSE_START) {
                risk += CONFIG.WAVE_DEFENSE_RISK_INC;
            }
            
            if (gameState.arrowActive) {
                risk = Math.max(0, risk - CONFIG.ARROW_RISK_REDUCE);
            }
            
            // æ£€æŸ¥æ˜¯å¦å¤±è´¥
            if (Math.random() * 100 < risk) {
                handleSneakFailure(`æ•Œè¯†ç ´è®¡ç­–ï¼é£é™©${risk}%è§¦å‘å¤±è´¥ï¼`);
                return;
            }
            
            // æˆåŠŸ
            handleSneakSuccess();
        }

        function handleSneakSuccess() {
            playSound('sneakAttack');
            gameState.supply += CONFIG.SNEAK_REWARD;
            gameState.wave++;
            gameState.waveStartTime = Date.now();
            gameState.confusion = 0;
            gameState.enemyEastPercent = CONFIG.INITIAL_ENEMY_EAST;
            gameState.sneakWindowOpen = false;
            gameState.intelActive = false;
            gameState.arrowActive = false;
            
            // æ·»åŠ èƒœåˆ©åŠ¨ç”»
            const westX = canvas.width * 0.75;
            const westY = canvas.height * 0.4;
            for (let i = 0; i < 50; i++) {
                gameState.particles.push(new Particle(westX, westY, 'fire'));
            }
            
            closeSneakWindow();
            updateUI();
            
            // æ£€æŸ¥èƒœåˆ©æ¡ä»¶
            if (gameState.supply >= CONFIG.LEGENDARY_SUPPLY) {
                endGame('legendary');
            } else if (gameState.supply >= CONFIG.VICTORY_SUPPLY) {
                endGame('victory');
            }
        }

        function handleSneakFailure(reason) {
            playSound('failure');
            gameState.supply = Math.max(0, gameState.supply - 100);
            
            // å¤±è´¥åŠ¨ç”»ï¼ˆç°å±æ•ˆæœï¼‰
            ctx.fillStyle = 'rgba(100, 100, 100, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            showEventPopup(reason);
            updateUI();
        }

        function useSmoke() {
            if (gameState.smokeCooldown > 0 || gameState.gameOver) return;
            
            gameState.confusion = Math.min(100, gameState.confusion + CONFIG.SMOKE_CONFUSION);
            gameState.smokeCooldown = CONFIG.SMOKE_CD;
            
            // æ·»åŠ çƒŸé›¾ç²’å­
            for (let i = 0; i < 30; i++) {
                const x = canvas.width * 0.5;
                const y = canvas.height * 0.5;
                gameState.particles.push(new Particle(x, y, 'smoke'));
            }
            
            updateUI();
        }

        function useIntel() {
            if (gameState.intelCooldown > 0 || gameState.gameOver) return;
            
            gameState.intelActive = true;
            gameState.intelCooldown = CONFIG.INTEL_CD;
            updateUI();
        }

        function useArrow() {
            if (gameState.arrowCooldown > 0 || gameState.gameOver) return;
            
            gameState.arrowActive = true;
            gameState.arrowCooldown = CONFIG.ARROW_CD;
            updateUI();
        }

        function updateCooldowns() {
            const delta = 100; // æ¯100msæ›´æ–°ä¸€æ¬¡
            if (gameState.smokeCooldown > 0) {
                gameState.smokeCooldown = Math.max(0, gameState.smokeCooldown - delta);
            }
            if (gameState.intelCooldown > 0) {
                gameState.intelCooldown = Math.max(0, gameState.intelCooldown - delta);
            }
            if (gameState.arrowCooldown > 0) {
                gameState.arrowCooldown = Math.max(0, gameState.arrowCooldown - delta);
            }
        }

        function triggerRandomEvent() {
            if (Math.random() < CONFIG.EVENT_ENEMY_SUSPICION) {
                // æ•Œæ–¥å€™ç–‘
                gameState.confusion = Math.max(0, gameState.confusion - 10);
                showEventPopup('âš ï¸ æ•Œæ–¥å€™ç–‘ï¼è¿·æƒ‘å€¼-10');
                playSound('failure');
            } else {
                // è¿·é›¾åŠ©æ”»
                gameState.supply += 50;
                showEventPopup('ğŸŒ«ï¸ è¿·é›¾åŠ©æ”»ï¼ç²®è‰+50ï¼Œæ—¶æœºçª—å£å»¶é•¿5ç§’');
                if (gameState.sneakWindowOpen) {
                    gameState.sneakWindowEnd += 5000;
                }
                playSound('victory');
            }
            updateUI();
        }

        // ==================== UI æ›´æ–° ====================
        function updateUI() {
            // è¿·æƒ‘å€¼
            const confusionPercent = Math.min(100, gameState.confusion);
            document.getElementById('confusionBar').style.width = confusionPercent + '%';
            document.getElementById('confusionText').textContent = Math.round(confusionPercent) + '%';
            
            // ç²®è‰
            document.getElementById('supplyText').textContent = `${gameState.supply}/1000`;
            
            // æ³¢æ¬¡
            document.getElementById('waveText').textContent = `${gameState.wave}/âˆ`;
            
            // æœ€é«˜åˆ†
            document.getElementById('highScoreText').textContent = getHighScore();
            
            // é—¨çŠ¶æ€
            document.getElementById('eastStatus').textContent = gameState.sneakWindowOpen ? 'å‡æ”»ä¸­' : 'å‡æ”»ä¸­';
            document.getElementById('westStatus').textContent = gameState.sneakWindowOpen ? 'å¥‡è¢­æ—¶æœºï¼' : 'å¾…æœº';
            
            // é“å…·æŒ‰é’®
            const smokeBtn = document.getElementById('smokeBtn');
            smokeBtn.disabled = gameState.smokeCooldown > 0;
            smokeBtn.textContent = `çƒŸé›¾ğŸ‘» (CD:${Math.ceil(gameState.smokeCooldown / 1000)}s)`;
            
            const intelBtn = document.getElementById('intelBtn');
            intelBtn.disabled = gameState.intelCooldown > 0;
            intelBtn.textContent = `å‡æƒ…æŠ¥ğŸ“œ (CD:${Math.ceil(gameState.intelCooldown / 1000)}s)`;
            
            const arrowBtn = document.getElementById('arrowBtn');
            arrowBtn.disabled = gameState.arrowCooldown > 0;
            arrowBtn.textContent = `å¼“ç®­ğŸ¹ (CD:${Math.ceil(gameState.arrowCooldown / 1000)}s)`;
        }

        function showEventPopup(text) {
            const popup = document.createElement('div');
            popup.className = 'event-popup';
            popup.textContent = text;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 2000);
        }

        function showModal(title, content, buttonText, onClose) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = `
                <div class="modal-title">${title}</div>
                <div class="modal-text">${content}</div>
                <button class="modal-btn" id="modalCloseBtn">${buttonText}</button>
            `;
            
            modal.style.display = 'flex';
            
            document.getElementById('modalCloseBtn').onclick = () => {
                modal.style.display = 'none';
                if (onClose) onClose();
            };
        }

        // ==================== æ¸¸æˆç»“æŸ ====================
        function endGame(type) {
            gameState.gameOver = true;
            
            const score = calculateScore();
            const isNewRecord = saveHighScore(score);
            
            let title, content, ending;
            
            if (type === 'legendary') {
                title = 'ğŸ‰ ç¥ç»“å±€ï¼šå£°ä¸œå‡»è¥¿ï¼Œå¤©ä¸‹æ— åŒï¼';
                ending = 'ä¼ å¥‡';
                content = `
                    <p>ä½ ä»¥è¶…å‡¡çš„æ™ºæ…§ä¸å‹‡æ°”ï¼Œå®Œç¾æ¼”ç»äº†"å£°ä¸œå‡»è¥¿"ä¹‹è®¡ï¼</p>
                    <p>ç²®è‰ï¼š${gameState.supply} | æ³¢æ¬¡ï¼š${gameState.wave} | åˆ†æ•°ï¼š${Math.round(score)}</p>
                    <p><strong>ä¸‰åå…­è®¡ç¬¬å…­è®¡ - å£°ä¸œå‡»è¥¿ï¼š</strong></p>
                    <p>æ•Œå¿—ä¹±èƒï¼Œä¸è™ï¼Œå¤ä¸‹å…‘ä¸Šä¹‹è±¡ã€‚åˆ©å…¶ä¸è‡ªä¸»è€Œå–ä¹‹ã€‚</p>
                    <p>å½“æ•Œäººæ„å¿—æ··ä¹±ã€æ— æ³•ç»Ÿä¸€æ—¶ï¼Œåˆ©ç”¨å…¶æ— æ³•è‡ªä¸»åˆ¤æ–­çš„å¼±ç‚¹ï¼Œæ”»å…¶ä¸å¤‡ï¼Œå‡ºå…¶ä¸æ„ã€‚</p>
                    <p>ä½ é€šè¿‡å‡æ”»ä¸œé—¨è¿·æƒ‘æ•Œäººï¼Œåœ¨æœ€ä½³æ—¶æœºå¥‡è¢­è¥¿é—¨ï¼Œå±•ç°äº†å®Œç¾çš„æˆ˜æœ¯æ™ºæ…§ï¼</p>
                    ${isNewRecord ? '<p style="color: #ffd700; font-size: 20px;">ğŸ† æ–°çºªå½•ï¼</p>' : ''}
                `;
            } else if (type === 'victory') {
                title = 'ğŸŠ å¤§èƒœï¼šå£°ä¸œå‡»è¥¿ï¼Œè®¡ç­–æˆåŠŸï¼';
                ending = 'å¤§èƒœ';
                content = `
                    <p>ä½ æˆåŠŸè¿ç”¨"å£°ä¸œå‡»è¥¿"ä¹‹è®¡ï¼Œå–å¾—äº†è¾‰ç…Œèƒœåˆ©ï¼</p>
                    <p>ç²®è‰ï¼š${gameState.supply} | æ³¢æ¬¡ï¼š${gameState.wave} | åˆ†æ•°ï¼š${Math.round(score)}</p>
                    <p><strong>ä¸‰åå…­è®¡ç¬¬å…­è®¡ - å£°ä¸œå‡»è¥¿ï¼š</strong></p>
                    <p>é€šè¿‡åœ¨ä¸œé—¨åˆ¶é€ å‡è±¡ï¼ŒæˆåŠŸå°†æ•Œä¸»åŠ›å¸å¼•è¿‡å»ï¼Œç„¶åå¥‡è¢­é˜²å®ˆè–„å¼±çš„è¥¿é—¨ï¼Œä¸€ä¸¾æˆåŠŸï¼</p>
                    ${isNewRecord ? '<p style="color: #ffd700; font-size: 20px;">ğŸ† æ–°çºªå½•ï¼</p>' : ''}
                `;
            }
            
            showModal(title, content, 'é‡æ–°å¼€å§‹', () => {
                resetGame();
            });
            
            playSound('victory');
        }

        function calculateScore() {
            const baseScore = gameState.supply;
            const waveMultiplier = Math.pow(CONFIG.SCORE_BASE_MULTIPLIER, gameState.wave);
            const itemBonus = (gameState.smokeCooldown === 0 ? 1 : 0.9) * 
                             (gameState.intelCooldown === 0 ? 1 : 0.9) * 
                             (gameState.arrowCooldown === 0 ? 1 : 0.9);
            return baseScore * waveMultiplier * itemBonus;
        }

        // ==================== æ¸¸æˆé‡ç½® ====================
        function resetGame() {
            gameState = {
                confusion: CONFIG.INITIAL_CONFUSION,
                supply: CONFIG.INITIAL_SUPPLY,
                wave: 1,
                enemyEastPercent: CONFIG.INITIAL_ENEMY_EAST,
                waveStartTime: Date.now(),
                waveElapsed: 0,
                sneakWindowOpen: false,
                sneakWindowStart: 0,
                sneakWindowEnd: 0,
                smokeCooldown: 0,
                intelCooldown: 0,
                arrowCooldown: 0,
                intelActive: false,
                arrowActive: false,
                animations: [],
                particles: [],
                gameStarted: true,
                gameOver: false,
                tutorialShown: false,
                isDragging: false,
                dragStartX: 0,
                dragStartY: 0,
                cameraOffsetX: 0,
                cameraOffsetY: 0,
            };
            
            updateUI();
        }

        // ==================== æ•™ç¨‹ ====================
        function showTutorial() {
            showModal(
                'ğŸ“– æ•™ç¨‹ï¼šå£°ä¸œå‡»è¥¿',
                `
                <p><strong>æ¸¸æˆç›®æ ‡ï¼š</strong>é€šè¿‡å‡æ”»ä¸œé—¨ç§¯ç´¯è¿·æƒ‘å€¼ï¼Œåœ¨æ—¶æœºæˆç†Ÿæ—¶å¥‡è¢­è¥¿é—¨ï¼Œç§¯ç´¯ç²®è‰è¾¾åˆ°1000ï¼ˆå¤§èƒœï¼‰æˆ–1500ï¼ˆç¥ç»“å±€ï¼‰ã€‚</p>
                <p><strong>æ“ä½œè¯´æ˜ï¼š</strong></p>
                <p>1. ç‚¹å‡»"å‡æ”»ä¸œé—¨"ç§¯ç´¯è¿·æƒ‘å€¼ï¼ˆæ¯æ¬¡+20ï¼‰</p>
                <p>2. å½“è¿·æƒ‘å€¼â‰¥70%æ—¶ï¼Œè¥¿é—¨å¥‡è¢­æŒ‰é’®ä¼šäº®èµ·</p>
                <p>3. åœ¨10ç§’æ—¶æœºçª—å£å†…ç‚¹å‡»"å¥‡è¢­è¥¿é—¨"ï¼ˆä¸è¦å¤ªæ—©ï¼ï¼‰</p>
                <p>4. ä½¿ç”¨é“å…·ï¼šçƒŸé›¾ï¼ˆ+è¿·æƒ‘30%ï¼‰ã€å‡æƒ…æŠ¥ï¼ˆå‡æ…¢æ•Œç§»åŠ¨ï¼‰ã€å¼“ç®­ï¼ˆé™ä½é£é™©ï¼‰</p>
                <p><strong>æç¤ºï¼š</strong>æ¯æ³¢éš¾åº¦é€’å¢ï¼Œç¬¬5æ³¢åé˜²å¾¡å¤§å¹…æå‡ã€‚æ³¨æ„éšæœºäº‹ä»¶ï¼</p>
                `,
                'å¼€å§‹æ¸¸æˆ',
                () => {
                    gameState.gameStarted = true;
                    gameState.tutorialShown = true;
                }
            );
        }

        // ==================== äº‹ä»¶ç›‘å¬ ====================
        document.getElementById('fakeAttackBtn').addEventListener('click', fakeAttack);
        document.getElementById('sneakAttackBtn').addEventListener('click', sneakAttack);
        document.getElementById('smokeBtn').addEventListener('click', useSmoke);
        document.getElementById('intelBtn').addEventListener('click', useIntel);
        document.getElementById('arrowBtn').addEventListener('click', useArrow);

        // æ‰‹æœºæ‹–æ‹½æ”¯æŒ
        canvas.addEventListener('touchstart', (e) => {
            gameState.isDragging = true;
            gameState.dragStartX = e.touches[0].clientX;
            gameState.dragStartY = e.touches[0].clientY;
        });

        canvas.addEventListener('touchmove', (e) => {
            if (gameState.isDragging) {
                const deltaX = e.touches[0].clientX - gameState.dragStartX;
                const deltaY = e.touches[0].clientY - gameState.dragStartY;
                gameState.cameraOffsetX += deltaX * 0.1;
                gameState.cameraOffsetY += deltaY * 0.1;
                gameState.dragStartX = e.touches[0].clientX;
                gameState.dragStartY = e.touches[0].clientY;
            }
        });

        canvas.addEventListener('touchend', () => {
            gameState.isDragging = false;
        });

        // ==================== æ¸¸æˆå¾ªç¯ ====================
        function gameLoop() {
            if (gameState.gameStarted && !gameState.gameOver) {
                updateWave();
            }
            
            updateUI();
            draw();
            
            requestAnimationFrame(gameLoop);
        }

        // ==================== åˆå§‹åŒ– ====================
        function init() {
            updateUI();
            document.getElementById('highScoreText').textContent = getHighScore();
            showTutorial();
            gameLoop();
        }

        init();
    </script>
</body>
</html>

